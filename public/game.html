<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UP SHIP! - Game</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: #e8e8e8;
    }

    .game-container {
      display: grid;
      grid-template-columns: 250px 1fr 300px;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      gap: 10px;
      padding: 10px;
    }

    /* Header */
    .game-header {
      grid-column: 1 / -1;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px;
    }

    .game-title {
      font-size: 1.5rem;
      color: #c4a35a;
    }

    .game-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .game-info-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 5px 15px;
      border-radius: 4px;
    }

    .game-info-label {
      font-size: 0.7rem;
      color: #888;
      text-transform: uppercase;
    }

    .game-info-value {
      font-size: 1rem;
      color: #c4a35a;
    }

    /* Left Sidebar - Resources */
    .sidebar-left {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      overflow-y: auto;
    }

    .section-title {
      color: #c4a35a;
      font-size: 0.9rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-bottom: 1px solid rgba(196, 163, 90, 0.3);
      padding-bottom: 5px;
    }

    .resource-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .resource-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }

    .resource-icon {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .resource-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: #c4a35a;
    }

    .resource-label {
      font-size: 0.7rem;
      color: #888;
      text-transform: uppercase;
    }

    .crew-section {
      margin-bottom: 20px;
    }

    .crew-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      margin-bottom: 5px;
    }

    .crew-name {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .crew-count {
      color: #c4a35a;
      font-weight: bold;
    }

    .income-badge {
      font-size: 0.7rem;
      color: #4a9;
      background: rgba(68, 170, 153, 0.2);
      padding: 2px 6px;
      border-radius: 3px;
    }

    /* Main Area - Blueprint */
    .main-area {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .blueprint-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .blueprint {
      background: linear-gradient(135deg, #2a2a4a 0%, #1a1a3a 100%);
      border: 2px solid #c4a35a;
      border-radius: 12px;
      padding: 20px;
      width: 100%;
      max-width: 600px;
    }

    .blueprint-title {
      text-align: center;
      color: #c4a35a;
      font-size: 1.2rem;
      margin-bottom: 15px;
    }

    .slot-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .slot {
      width: 80px;
      height: 80px;
      border: 2px dashed rgba(196, 163, 90, 0.5);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .slot:hover {
      border-color: #c4a35a;
      background: rgba(196, 163, 90, 0.1);
    }

    .slot.filled {
      border-style: solid;
      background: rgba(196, 163, 90, 0.2);
    }

    .slot-icon {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .slot-label {
      font-size: 0.6rem;
      color: #888;
      text-transform: uppercase;
    }

    .slot-type-label {
      text-align: center;
      color: #666;
      font-size: 0.7rem;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    /* Ship Stats */
    .ship-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(196, 163, 90, 0.3);
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #c4a35a;
    }

    .stat-label {
      font-size: 0.7rem;
      color: #888;
      text-transform: uppercase;
    }

    /* Right Sidebar - Cards & Actions */
    .sidebar-right {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .hand-section {
      flex: 1;
      margin-bottom: 15px;
    }

    .cards-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card {
      background: linear-gradient(135deg, #3a3a5a 0%, #2a2a4a 100%);
      border: 1px solid rgba(196, 163, 90, 0.5);
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card:hover {
      transform: translateX(5px);
      border-color: #c4a35a;
    }

    .card-name {
      font-size: 0.85rem;
      color: #e8e8e8;
    }

    .card-type {
      font-size: 0.65rem;
      color: #888;
      text-transform: uppercase;
    }

    .actions-section {
      border-top: 1px solid rgba(196, 163, 90, 0.3);
      padding-top: 15px;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .action-btn {
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Georgia', serif;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .action-btn.primary {
      background: #c4a35a;
      color: #1a1a2e;
    }

    .action-btn.primary:hover {
      background: #d4b36a;
    }

    .action-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #e8e8e8;
      border: 1px solid rgba(196, 163, 90, 0.5);
    }

    .action-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Bottom - Log */
    .game-log {
      grid-column: 1 / -1;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px 15px;
      max-height: 120px;
      overflow-y: auto;
    }

    .log-entry {
      font-size: 0.8rem;
      padding: 3px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: #666;
      margin-right: 10px;
    }

    .log-message {
      color: #aaa;
    }

    .log-message.system {
      color: #c4a35a;
    }

    /* Technologies */
    .tech-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .tech-item {
      background: rgba(68, 170, 153, 0.2);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tech-icon {
      font-size: 1rem;
    }

    /* Loading state */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 1.2rem;
      color: #888;
    }

    /* Turn indicator */
    .turn-indicator {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
    }

    .turn-indicator.your-turn {
      background: rgba(68, 170, 153, 0.3);
      color: #4a9;
      animation: pulse 2s infinite;
    }

    .turn-indicator.waiting {
      background: rgba(255, 255, 255, 0.1);
      color: #888;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Players list */
    .players-list {
      margin-bottom: 20px;
    }

    .player-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      margin-bottom: 5px;
    }

    .player-item.current {
      border-left: 3px solid #4a9;
    }

    .player-name {
      font-size: 0.85rem;
    }

    .player-faction {
      font-size: 0.7rem;
      color: #888;
    }

    .player-cash {
      color: #c4a35a;
      font-size: 0.85rem;
    }

    /* Gas display */
    .gas-cubes {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }

    .gas-cube {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }

    .gas-cube.hydrogen {
      background: #e74c3c;
      color: white;
    }

    .gas-cube.helium {
      background: #3498db;
      color: white;
    }

    /* Back button */
    .back-btn {
      background: transparent;
      border: 1px solid rgba(196, 163, 90, 0.5);
      color: #c4a35a;
      padding: 5px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Georgia', serif;
    }

    .back-btn:hover {
      background: rgba(196, 163, 90, 0.1);
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 2px solid #c4a35a;
      border-radius: 12px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(196, 163, 90, 0.3);
    }

    .modal-title {
      color: #c4a35a;
      font-size: 1.2rem;
    }

    .modal-close {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .modal-close:hover {
      color: #c4a35a;
    }

    .upgrade-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .upgrade-option {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(196, 163, 90, 0.3);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upgrade-option:hover {
      background: rgba(196, 163, 90, 0.1);
      border-color: #c4a35a;
    }

    .upgrade-option.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .upgrade-name {
      font-size: 1rem;
      color: #e8e8e8;
      margin-bottom: 5px;
    }

    .upgrade-stats {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 0.75rem;
    }

    .upgrade-stat {
      background: rgba(68, 170, 153, 0.2);
      color: #4a9;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .upgrade-stat.negative {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    .upgrade-required {
      font-size: 0.7rem;
      color: #888;
      margin-top: 5px;
    }

    .upgrade-required.missing {
      color: #e74c3c;
    }

    .remove-btn {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid #e74c3c;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Georgia', serif;
      margin-top: 10px;
      width: 100%;
    }

    .remove-btn:hover {
      background: rgba(231, 76, 60, 0.4);
    }

    .no-upgrades {
      color: #888;
      text-align: center;
      padding: 20px;
    }

    /* Slot with upgrade */
    .slot.filled .slot-icon {
      font-size: 1.2rem;
    }

    .slot.filled .slot-label {
      font-size: 0.55rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70px;
    }

    /* Physics indicator */
    .physics-check {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
    }

    .physics-item {
      text-align: center;
    }

    .physics-value {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .physics-value.ok {
      color: #4a9;
    }

    .physics-value.warning {
      color: #e74c3c;
    }

    .physics-label {
      font-size: 0.7rem;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="game-container" id="game-container">
    <div class="loading">Loading game...</div>
  </div>
  <div id="modal-container"></div>

  <script>
    // Get game ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('id');

    let gameState = null;
    let currentUserId = null;
    let refreshInterval = null;
    let upgradesData = null;

    // Upgrade definitions (loaded from server)
    const SLOT_ICONS = {
      frame: 'üî©',
      fabric: 'üé®',
      drive: '‚öôÔ∏è',
      component: 'üì¶'
    };

    const SLOT_NAMES = {
      frame: 'Frame',
      fabric: 'Fabric',
      drive: 'Drive',
      component: 'Component'
    };

    const STAT_NAMES = {
      speed: 'Speed',
      range: 'Range',
      ceiling: 'Ceiling',
      reliability: 'Reliability',
      luxury: 'Luxury',
      income: 'Income'
    };

    // Age baseline stats
    const AGE_BASELINES = {
      1: { speed: 1, range: 1, ceiling: 0, reliability: 0 },
      2: { speed: 2, range: 2, ceiling: 1, reliability: 1 },
      3: { speed: 3, range: 3, ceiling: 2, reliability: 2 }
    };

    // Initialize
    async function init() {
      if (!gameId) {
        window.location.href = '/';
        return;
      }

      // Check auth and get user ID
      try {
        const authRes = await fetch('/api/auth/me');
        if (!authRes.ok) {
          window.location.href = '/';
          return;
        }
        const authData = await authRes.json();
        currentUserId = authData.user.id;
      } catch (err) {
        window.location.href = '/';
        return;
      }

      // Load upgrades data
      await loadUpgrades();

      await loadGameState();

      // Refresh state every 5 seconds
      refreshInterval = setInterval(loadGameState, 5000);
    }

    // Load upgrades data
    async function loadUpgrades() {
      try {
        const res = await fetch(`/api/state/${gameId}/upgrades`);
        if (res.ok) {
          upgradesData = await res.json();
        }
      } catch (err) {
        console.error('Failed to load upgrades:', err);
      }
    }

    // Load game state
    async function loadGameState() {
      try {
        const res = await fetch(`/api/state/${gameId}`);
        if (!res.ok) {
          if (res.status === 404) {
            // Game state not initialized - maybe game hasn't started
            window.location.href = '/?game=' + gameId;
            return;
          }
          throw new Error('Failed to load game state');
        }

        const data = await res.json();
        gameState = data.gameState;
        renderGame();
      } catch (err) {
        console.error('Load game state error:', err);
        document.getElementById('game-container').innerHTML =
          '<div class="loading">Failed to load game. <a href="/" style="color: #c4a35a;">Return to lobby</a></div>';
      }
    }

    // Render the game
    function renderGame() {
      if (!gameState || !gameState.state) return;

      const state = gameState.state;
      const myState = state.players[currentUserId];
      const isMyTurn = state.playerOrder[state.currentPlayerIndex] === currentUserId;

      document.getElementById('game-container').innerHTML = `
        <!-- Header -->
        <div class="game-header">
          <div style="display: flex; align-items: center; gap: 20px;">
            <button class="back-btn" onclick="goBack()">‚Üê Lobby</button>
            <span class="game-title">UP SHIP!</span>
          </div>
          <div class="game-info">
            <div class="game-info-item">
              <div class="game-info-label">Age</div>
              <div class="game-info-value">${state.age}</div>
            </div>
            <div class="game-info-item">
              <div class="game-info-label">Turn</div>
              <div class="game-info-value">${state.turn}</div>
            </div>
            <div class="game-info-item">
              <div class="game-info-label">Phase</div>
              <div class="game-info-value">${state.phase}</div>
            </div>
            <div class="turn-indicator ${isMyTurn ? 'your-turn' : 'waiting'}">
              ${isMyTurn ? '‚ö° Your Turn' : '‚è≥ Waiting...'}
            </div>
          </div>
        </div>

        <!-- Left Sidebar - Resources -->
        <div class="sidebar-left">
          <div class="section-title">Resources</div>
          <div class="resource-grid">
            <div class="resource-item">
              <div class="resource-icon">üí∞</div>
              <div class="resource-value">¬£${myState.cash}</div>
              <div class="resource-label">Cash</div>
            </div>
            <div class="resource-item">
              <div class="resource-icon">üìà</div>
              <div class="resource-value">¬£${myState.income}</div>
              <div class="resource-label">Income</div>
            </div>
          </div>

          <div class="section-title">Crew</div>
          <div class="crew-section">
            <div class="crew-item">
              <div class="crew-name">
                <span>üßë‚Äç‚úàÔ∏è</span>
                <span>Pilots</span>
              </div>
              <div>
                <span class="crew-count">${myState.pilots}</span>
                <span class="income-badge">+${myState.pilotIncome}/turn</span>
              </div>
            </div>
            <div class="crew-item">
              <div class="crew-name">
                <span>üîß</span>
                <span>Engineers</span>
              </div>
              <div>
                <span class="crew-count">${myState.engineers}</span>
                <span class="income-badge">+${myState.engineerIncome}/turn</span>
              </div>
            </div>
            <div class="crew-item">
              <div class="crew-name">
                <span>üïµÔ∏è</span>
                <span>Agents</span>
              </div>
              <span class="crew-count">${myState.agents}</span>
            </div>
          </div>

          <div class="section-title">Gas Reserve</div>
          <div class="gas-cubes">
            ${Array(myState.gasCubes.hydrogen).fill('<div class="gas-cube hydrogen">H</div>').join('')}
            ${Array(myState.gasCubes.helium).fill('<div class="gas-cube helium">He</div>').join('')}
            ${myState.gasCubes.hydrogen + myState.gasCubes.helium === 0 ? '<span style="color: #666; font-size: 0.8rem;">Empty</span>' : ''}
          </div>
          <div style="margin-top: 10px; font-size: 0.75rem; color: #888;">
            Market: H‚ÇÇ ¬£${state.gasMarket.hydrogen}/cube | He ¬£${state.gasMarket.helium}/cube
          </div>

          <div class="section-title" style="margin-top: 20px;">Technologies</div>
          <div class="tech-list">
            ${myState.technologies.length > 0 ?
              myState.technologies.map(t => `
                <div class="tech-item">
                  <span class="tech-icon">üìú</span>
                  <span>${formatTechName(t)}</span>
                </div>
              `).join('') :
              '<div style="color: #666; font-size: 0.8rem;">No technologies yet</div>'
            }
          </div>

          <div class="section-title" style="margin-top: 20px;">Players</div>
          <div class="players-list">
            ${state.playerOrder.map((pid, idx) => {
              const player = state.players[pid];
              const isCurrent = idx === state.currentPlayerIndex;
              const isMe = pid === currentUserId;
              return `
                <div class="player-item ${isCurrent ? 'current' : ''}">
                  <div>
                    <div class="player-name">${isMe ? 'You' : 'Player'} ${getFactionFlag(player.faction)}</div>
                    <div class="player-faction">${player.faction}</div>
                  </div>
                  <div class="player-cash">¬£${player.cash}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- Main Area - Blueprint -->
        <div class="main-area">
          <div class="blueprint-container">
            <div class="blueprint">
              <div class="blueprint-title">Age ${myState.blueprint.age} Blueprint - ${getFactionName(myState.faction)}</div>

              <div class="slot-type-label">Frame Slots</div>
              <div class="slot-row">
                ${myState.blueprint.frameSlots.map((slot, i) => `
                  <div class="slot ${slot ? 'filled' : ''}" onclick="openSlot('frame', ${i})">
                    <div class="slot-icon">${slot ? 'üî©' : '‚ûï'}</div>
                    <div class="slot-label">${getUpgradeName(slot)}</div>
                  </div>
                `).join('')}
              </div>

              <div class="slot-type-label">Fabric Slots</div>
              <div class="slot-row">
                ${myState.blueprint.fabricSlots.map((slot, i) => `
                  <div class="slot ${slot ? 'filled' : ''}" onclick="openSlot('fabric', ${i})">
                    <div class="slot-icon">${slot ? 'üé®' : '‚ûï'}</div>
                    <div class="slot-label">${getUpgradeName(slot)}</div>
                  </div>
                `).join('')}
              </div>

              <div class="slot-type-label">Drive Slots</div>
              <div class="slot-row">
                ${myState.blueprint.driveSlots.map((slot, i) => `
                  <div class="slot ${slot ? 'filled' : ''}" onclick="openSlot('drive', ${i})">
                    <div class="slot-icon">${slot ? '‚öôÔ∏è' : '‚ûï'}</div>
                    <div class="slot-label">${getUpgradeName(slot)}</div>
                  </div>
                `).join('')}
              </div>

              <div class="slot-type-label">Component Slots</div>
              <div class="slot-row">
                ${myState.blueprint.componentSlots.map((slot, i) => `
                  <div class="slot ${slot ? 'filled' : ''}" onclick="openSlot('component', ${i})">
                    <div class="slot-icon">${slot ? 'üì¶' : '‚ûï'}</div>
                    <div class="slot-label">${getUpgradeName(slot)}</div>
                  </div>
                `).join('')}
              </div>

              <div class="ship-stats">
                <div class="stat">
                  <div class="stat-value">${calculateStat(myState, 'speed')}</div>
                  <div class="stat-label">Speed</div>
                </div>
                <div class="stat">
                  <div class="stat-value">${calculateStat(myState, 'range')}</div>
                  <div class="stat-label">Range</div>
                </div>
                <div class="stat">
                  <div class="stat-value">${calculateStat(myState, 'ceiling')}</div>
                  <div class="stat-label">Ceiling</div>
                </div>
                <div class="stat">
                  <div class="stat-value">${calculateStat(myState, 'reliability')}</div>
                  <div class="stat-label">Reliability</div>
                </div>
                <div class="stat">
                  <div class="stat-value">${calculateStat(myState, 'luxury')}</div>
                  <div class="stat-label">Luxury</div>
                </div>
              </div>

              <div class="physics-check">
                <div class="physics-item">
                  <div class="physics-value ${calculateLift(myState) >= calculateWeight(myState) ? 'ok' : 'warning'}">
                    ${calculateLift(myState)}
                  </div>
                  <div class="physics-label">Lift</div>
                </div>
                <div class="physics-item">
                  <div style="font-size: 1.2rem; color: #888;">vs</div>
                </div>
                <div class="physics-item">
                  <div class="physics-value">${calculateWeight(myState)}</div>
                  <div class="physics-label">Weight</div>
                </div>
                <div class="physics-item" style="margin-left: 20px;">
                  <div class="physics-value ${calculateLift(myState) >= calculateWeight(myState) ? 'ok' : 'warning'}">
                    ${calculateLift(myState) >= calculateWeight(myState) ? '‚úì' : '‚úó'}
                  </div>
                  <div class="physics-label">Can Launch</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Sidebar - Cards & Actions -->
        <div class="sidebar-right">
          <div class="hand-section">
            <div class="section-title">Hand (${myState.hand.length} cards)</div>
            <div class="cards-container">
              ${myState.hand.map((card, i) => `
                <div class="card" onclick="playCard(${i})">
                  <div class="card-name">${card.name}</div>
                  <div class="card-type">${card.type}</div>
                </div>
              `).join('')}
              ${myState.hand.length === 0 ? '<div style="color: #666; font-size: 0.8rem;">No cards in hand</div>' : ''}
            </div>
            <div style="margin-top: 10px; font-size: 0.75rem; color: #888;">
              Deck: ${myState.deck} | Discard: ${myState.discardPile?.length || 0}
            </div>
          </div>

          <div class="section-title">R&D Board</div>
          <div class="cards-container" style="margin-bottom: 15px;">
            ${state.rdBoard.map(tech => `
              <div class="card" onclick="acquireTech('${tech.id}')">
                <div class="card-name">${tech.name}</div>
                <div class="card-type">${tech.type} - ¬£${tech.cost}</div>
              </div>
            `).join('')}
          </div>

          <div class="actions-section">
            <div class="section-title">Actions</div>
            <div class="action-buttons">
              <button class="action-btn secondary" onclick="buyGas('hydrogen')" ${!isMyTurn ? 'disabled' : ''}>
                Buy Hydrogen (¬£${state.gasMarket.hydrogen})
              </button>
              <button class="action-btn secondary" onclick="buyGas('helium')" ${!isMyTurn ? 'disabled' : ''}>
                Buy Helium (¬£${state.gasMarket.helium})
              </button>
              <button class="action-btn secondary" onclick="drawCards()" ${!isMyTurn ? 'disabled' : ''}>
                Draw Card
              </button>
              <button class="action-btn primary" onclick="endTurn()" ${!isMyTurn ? 'disabled' : ''}>
                End Turn
              </button>
            </div>
          </div>
        </div>

        <!-- Game Log -->
        <div class="game-log">
          ${(state.log || []).slice(-10).reverse().map(entry => `
            <div class="log-entry">
              <span class="log-time">${new Date(entry.timestamp).toLocaleTimeString()}</span>
              <span class="log-message ${entry.type}">${entry.message}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Helper functions
    function getFactionFlag(faction) {
      const flags = { germany: 'üá©üá™', britain: 'üá¨üáß', usa: 'üá∫üá∏', italy: 'üáÆüáπ' };
      return flags[faction] || 'üè≥Ô∏è';
    }

    function getFactionName(faction) {
      const names = { germany: 'Germany', britain: 'Britain', usa: 'United States', italy: 'Italy' };
      return names[faction] || faction;
    }

    function formatTechName(tech) {
      return tech.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function calculateStat(playerState, stat) {
      const age = gameState?.state?.age || 1;
      const baseline = AGE_BASELINES[age];

      // Start with baseline + faction bonus
      let value = (baseline[stat] || 0) + (playerState.bonuses?.[stat] || 0);

      // Add stats from installed upgrades
      if (upgradesData?.allUpgrades && playerState.blueprint) {
        const slots = ['frameSlots', 'fabricSlots', 'driveSlots', 'componentSlots'];
        for (const slotKey of slots) {
          const slotArray = playerState.blueprint[slotKey] || [];
          for (const upgradeId of slotArray) {
            if (!upgradeId) continue;
            const upgrade = upgradesData.allUpgrades[upgradeId];
            if (upgrade?.stats?.[stat]) {
              value += upgrade.stats[stat];
            }
          }
        }
      }

      return value;
    }

    // Calculate total weight from upgrades
    function calculateWeight(playerState) {
      let weight = 0;
      if (upgradesData?.allUpgrades && playerState.blueprint) {
        const slots = ['frameSlots', 'fabricSlots', 'driveSlots', 'componentSlots'];
        for (const slotKey of slots) {
          const slotArray = playerState.blueprint[slotKey] || [];
          for (const upgradeId of slotArray) {
            if (!upgradeId) continue;
            const upgrade = upgradesData.allUpgrades[upgradeId];
            if (upgrade?.weight) {
              weight += Math.abs(upgrade.weight);
            }
          }
        }
      }
      return weight;
    }

    // Calculate lift from gas cubes
    function calculateLift(playerState) {
      let lift = 0;
      const gasSockets = playerState.blueprint?.gasSockets || [];
      for (const cube of gasSockets) {
        if (cube === 'hydrogen' || cube === 'helium') {
          lift += 5;
        }
      }
      return lift;
    }

    // Get upgrade name from ID
    function getUpgradeName(upgradeId) {
      if (!upgradeId) return 'Empty';
      if (upgradesData?.allUpgrades?.[upgradeId]) {
        return upgradesData.allUpgrades[upgradeId].name;
      }
      return formatTechName(upgradeId);
    }

    // Action functions
    async function performAction(actionType, actionData = {}) {
      try {
        const res = await fetch(`/api/state/${gameId}/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actionType, actionData })
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || 'Action failed');
          return;
        }

        gameState = data.gameState;
        renderGame();
      } catch (err) {
        console.error('Action error:', err);
        alert('Failed to perform action');
      }
    }

    function endTurn() {
      performAction('END_TURN');
    }

    function buyGas(gasType) {
      performAction('BUY_GAS', { gasType, amount: 1 });
    }

    function acquireTech(techId) {
      performAction('ACQUIRE_TECHNOLOGY', { techId });
    }

    function playCard(cardIndex) {
      performAction('PLAY_CARD', { cardIndex });
    }

    function drawCards() {
      performAction('DRAW_CARDS', { count: 1 });
    }

    function openSlot(slotType, slotIndex) {
      if (!gameState?.state) return;

      const state = gameState.state;
      const myState = state.players[currentUserId];
      const slotKey = `${slotType}Slots`;
      const currentUpgrade = myState.blueprint[slotKey]?.[slotIndex];

      // Show the upgrade modal
      showUpgradeModal(slotType, slotIndex, currentUpgrade);
    }

    // Show upgrade selection modal
    function showUpgradeModal(slotType, slotIndex, currentUpgrade) {
      const container = document.getElementById('modal-container');
      const slotKey = `${slotType}Slots`;
      const state = gameState.state;
      const myState = state.players[currentUserId];

      // Get available upgrades for this slot type
      const available = upgradesData?.available?.[slotKey] || [];
      const allUpgrades = upgradesData?.allUpgrades || {};
      const allTechs = upgradesData?.allTechnologies || {};

      // Get all possible upgrades for this slot type (even locked ones)
      const allForSlot = Object.values(allUpgrades).filter(u => u.slotType === slotKey);

      let html = `
        <div class="modal-overlay" onclick="closeModal(event)">
          <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
              <span class="modal-title">${SLOT_ICONS[slotType]} ${SLOT_NAMES[slotType]} Slot ${slotIndex + 1}</span>
              <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
      `;

      // If slot has an upgrade, show remove option
      if (currentUpgrade) {
        const upgrade = allUpgrades[currentUpgrade];
        html += `
          <div style="margin-bottom: 15px; padding: 10px; background: rgba(196, 163, 90, 0.1); border-radius: 8px;">
            <div style="font-weight: bold; margin-bottom: 5px;">Currently Installed:</div>
            <div class="upgrade-name">${upgrade?.name || currentUpgrade}</div>
            ${renderUpgradeStats(upgrade)}
            <button class="remove-btn" onclick="removeUpgrade('${slotType}', ${slotIndex})">
              Remove Upgrade
            </button>
          </div>
        `;
      }

      // Show available upgrades
      html += `<div class="section-title" style="margin-bottom: 10px;">Available Upgrades</div>`;

      if (available.length === 0 && allForSlot.length === 0) {
        html += `<div class="no-upgrades">No upgrades available for this slot type.</div>`;
      } else {
        html += `<div class="upgrade-list">`;

        // First show available (unlocked) upgrades
        for (const upgrade of available) {
          // Skip if already installed
          if (currentUpgrade === upgrade.id) continue;

          html += `
            <div class="upgrade-option" onclick="installUpgrade('${slotType}', ${slotIndex}, '${upgrade.id}')">
              <div class="upgrade-name">${upgrade.name}</div>
              ${renderUpgradeStats(upgrade)}
            </div>
          `;
        }

        // Then show locked upgrades
        const availableIds = available.map(u => u.id);
        const locked = allForSlot.filter(u => !availableIds.includes(u.id) && u.age <= state.age);

        for (const upgrade of locked) {
          if (currentUpgrade === upgrade.id) continue;

          const tech = allTechs[upgrade.requiredTech];
          html += `
            <div class="upgrade-option locked">
              <div class="upgrade-name">${upgrade.name}</div>
              ${renderUpgradeStats(upgrade)}
              <div class="upgrade-required missing">
                Requires: ${tech?.name || upgrade.requiredTech}
              </div>
            </div>
          `;
        }

        html += `</div>`;
      }

      html += `
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Render upgrade stats as badges
    function renderUpgradeStats(upgrade) {
      if (!upgrade) return '';

      let html = '<div class="upgrade-stats">';

      // Show weight
      if (upgrade.weight) {
        html += `<span class="upgrade-stat negative">Weight ${Math.abs(upgrade.weight)}</span>`;
      }

      // Show stats
      if (upgrade.stats) {
        for (const [stat, value] of Object.entries(upgrade.stats)) {
          if (value > 0) {
            html += `<span class="upgrade-stat">+${value} ${STAT_NAMES[stat] || stat}</span>`;
          }
        }
      }

      // Show hull cost
      if (upgrade.hullCost) {
        html += `<span class="upgrade-stat negative">+¬£${upgrade.hullCost} Hull</span>`;
      }

      html += '</div>';
      return html;
    }

    // Close modal
    function closeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('modal-container').innerHTML = '';
    }

    // Install upgrade action
    async function installUpgrade(slotType, slotIndex, upgradeId) {
      closeModal();
      await performAction('INSTALL_UPGRADE', { slotType, slotIndex, upgradeId });
      // Reload upgrades data in case it changed
      await loadUpgrades();
    }

    // Remove upgrade action
    async function removeUpgrade(slotType, slotIndex) {
      closeModal();
      await performAction('REMOVE_UPGRADE', { slotType, slotIndex });
    }

    function goBack() {
      clearInterval(refreshInterval);
      window.location.href = '/';
    }

    // Start
    init();
  </script>
</body>
</html>
